<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AuraView - Integrated Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        /* CSS bilkul wahi hai jo video feed wale version mein thi */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f0f0f; color: #e0e0e0; display: grid; grid-template-columns: 1fr 2fr; grid-template-rows: auto 1fr; grid-template-areas: "header header" "sidebar main"; height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; gap: 20px; overflow: hidden; }
        .header { grid-area: header; text-align: center; font-size: 1.8em; color: #00ff87; margin-bottom: 10px; }
        .sidebar { grid-area: sidebar; display: flex; flex-direction: column; gap: 20px; }
        .main-content { grid-area: main; display: flex; flex-direction: column; gap: 20px; min-height: 0; }
        .panel { background-color: #1a1a1a; border-radius: 15px; padding: 20px; border: 1px solid #333; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); }
        .count-box { text-align: center; transition: border-color 0.5s ease, box-shadow 0.5s ease; }
        .count-label { font-size: 1.1em; color: #888; margin-bottom: 5px; }
        .count-display { font-size: 4em; font-weight: 700; line-height: 1; margin-bottom: 10px; }
        .prediction-display { font-size: 1.2em; color: #ccc; }
        .status-safe { border-color: #00ff87; box-shadow: 0 0 10px rgba(0, 255, 135, 0.15); }
        .status-moderate { border-color: #ffc107; box-shadow: 0 0 10px rgba(255, 193, 7, 0.2); }
        .status-danger { border-color: #dc3545; box-shadow: 0 0 10px rgba(220, 53, 69, 0.3); }
        .video-panel { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        .video-panel h2 { margin-top: 0; font-size: 1.3em; color: #bbb; text-align: center; }
        .video-wrapper { width: 100%; flex-grow: 1; background-color: black; border-radius: 10px; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .video-wrapper img { display: block; width: 100%; height: auto; max-height: 100%; object-fit: contain; }
        .chart-container { height: 250px; }
        #liveChart { max-height: 100%; }
    </style>
</head>
<body>
    <div class="header">AuraView - Integrated Monitoring</div>

    <div class="sidebar">
        <div id="count-box" class="panel count-box status-safe">
            <div class="count-label">Live People Count</div>
            <div id="count" class="count-display">0</div>
            <div id="prediction" class="prediction-display">Prediction: ~0</div>
        </div>
        <div class="panel chart-container">
             <canvas id="liveChart"></canvas>
        </div>
    </div>

    <div class="main-content">
        <div class="panel video-panel">
            <h2>Live Feed</h2>
            <div class="video-wrapper">
                <img id="videoFeedElement" src="/video_feed" alt="Loading live feed..." />
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // Check karna ki connection path sahi hai ya nahin
        const socket = io("http://localhost:8000"); // Use default path
        const countElement = document.getElementById('count');
        const predictionElement = document.getElementById('prediction');
        const countBoxElement = document.getElementById('count-box');
        let originalTitle = document.title;
        let alertActive = false;
        const ALERT_THRESHOLD = 10;

        // Chart setup
        const ctx = document.getElementById('liveChart').getContext('2d');
        const liveChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [ { label: 'Live Count', data: [], borderColor: '#00ff87', backgroundColor: 'rgba(0, 255, 135, 0.1)', fill: true, tension: 0.4, borderWidth: 2 }, { label: 'Predicted Count', data: [], borderColor: '#0dcaf0', borderDash: [5, 5], fill: false, tension: 0.4, borderWidth: 2 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: 'white' } }, x: { ticks: { color: 'white' } } }, plugins: { legend: { labels: { color: 'white' } }, annotation: { annotations: { thresholdLine: { type: 'line', yMin: ALERT_THRESHOLD, yMax: ALERT_THRESHOLD, borderColor: 'red', borderWidth: 2, borderDash: [10, 5], label: { content: 'Alert Threshold', display: true, position: 'end', color: 'red', backgroundColor: 'rgba(30, 30, 30, 0.6)' } } } } } }
        });

        function addDataToChart(label, liveData, predictedData) {
            liveChart.data.labels.push(label);
            liveChart.data.datasets[0].data.push(liveData);
            liveChart.data.datasets[1].data.push(predictedData);
            if (liveChart.data.labels.length > 20) { liveChart.data.labels.shift(); liveChart.data.datasets.forEach((ds) => ds.data.shift()); }
            liveChart.update();
        }

        socket.on('connect', () => {
             console.log('✅ Server se connect ho gaya!');
             countElement.innerText = "0";
             predictionElement.innerText = "Prediction: ~0";
             countBoxElement.className = 'panel count-box status-safe'; // Ensure panel class is also included
         });
        socket.on('disconnect', () => {
             console.log('❌ Server se connection toot gaya!');
             countElement.innerText = "Offline";
             predictionElement.innerText = "Prediction: Offline";
             countBoxElement.className = 'panel count-box'; // Reset class
         });

        // Jab server se naya data aaye
        socket.on('broadcast_data', (data) => {
            console.log("Data received:", data); // Check if data is coming
            const count = data.count;
            const prediction = data.prediction;

            countElement.innerText = count;
            predictionElement.innerText = `Prediction: ~${prediction}`;

            if (count > ALERT_THRESHOLD) {
                countBoxElement.className = 'panel count-box status-danger';
                if (!alertActive) { document.title = "🚨 CROWD ALERT! 🚨"; alertActive = true; }
            } else if (count > ALERT_THRESHOLD / 2) {
                countBoxElement.className = 'panel count-box status-moderate';
                if (alertActive) { document.title = originalTitle; alertActive = false; }
            } else {
                countBoxElement.className = 'panel count-box status-safe';
                if (alertActive) { document.title = originalTitle; alertActive = false; }
            }

            const currentTime = new Date().toLocaleTimeString();
            addDataToChart(currentTime, count, prediction);
        });

        const videoFeedImg = document.getElementById('videoFeedElement');
        videoFeedImg.onerror = () => console.error("Error loading video feed.");
    </script>
</body>
</html>