<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AuraView - Integrated Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        /* CSS bilkul wahi hai jo video feed wale version mein thi */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f0f0f; color: #e0e0e0; display: grid; grid-template-columns: 1fr 2fr; grid-template-rows: auto 1fr; grid-template-areas: "header header" "sidebar main"; height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; gap: 20px; overflow: hidden; }
        .header { grid-area: header; text-align: center; font-size: 1.8em; color: #00ff87; margin-bottom: 10px; }
        .sidebar { grid-area: sidebar; display: flex; flex-direction: column; gap: 20px; }
        .main-content { grid-area: main; display: flex; flex-direction: column; gap: 20px; min-height: 0; }
        .panel { background-color: #1a1a1a; border-radius: 15px; padding: 20px; border: 1px solid #333; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); }
        .count-box { text-align: center; transition: border-color 0.5s ease, box-shadow 0.5s ease; }
        .count-label { font-size: 1.1em; color: #888; margin-bottom: 5px; }
        .count-display { font-size: 4em; font-weight: 700; line-height: 1; margin-bottom: 10px; transition: color 0.5s ease; }
        
        /* Prediction area styles */
        .prediction-box { margin-top: 15px; }
        .prediction-label { font-size: 0.9em; color: #888; }
        .prediction-display { font-size: 1.2em; color: #ccc; margin-bottom: 10px; }
        .slider-container { margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.8em; color: #888;}
        input[type=range] { width: 60%; cursor: pointer; accent-color: #00ff87; }
        
        .status-safe { border-color: #00ff87; box-shadow: 0 0 10px rgba(0, 255, 135, 0.15); }
        .status-safe .count-display { color: #00ff87; }
        .status-moderate { border-color: #ffc107; box-shadow: 0 0 10px rgba(255, 193, 7, 0.2); }
        .status-moderate .count-display { color: #ffc107; }
        .status-danger { border-color: #dc3545; box-shadow: 0 0 10px rgba(220, 53, 69, 0.3); }
        .status-danger .count-display { color: #dc3545; }

        .video-panel { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        .video-panel h2 { margin-top: 0; font-size: 1.3em; color: #bbb; text-align: center; }
        .video-wrapper { width: 100%; flex-grow: 1; background-color: black; border-radius: 10px; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .video-wrapper img { display: block; width: 100%; height: auto; max-height: 100%; object-fit: contain; }
        .chart-container { height: 250px; }
        #liveChart { max-height: 100%; }
    </style>
</head>
<body>
    <div class="header">AuraView - Integrated Monitoring</div>

    <div class="sidebar">
        <div id="count-box" class="panel count-box status-safe">
            <div class="count-label">Live People Count</div>
            <div id="count" class="count-display">0</div>
            
            <div class="prediction-box">
                <div id="prediction-label" class="prediction-label">Prediction (Next 5 min):</div>
                <div id="prediction" class="prediction-display">~0</div>
                <div class="slider-container">
                    <span>5m</span>
                    <input type="range" id="predictionSlider" min="5" max="60" step="5" value="5">
                    <span>60m</span>
                </div>
            </div>
        </div>
        <div class="panel chart-container">
             <canvas id="liveChart"></canvas>
        </div>
    </div>

    <div class="main-content">
        <div class="panel video-panel">
            <h2>Live Feed</h2>
            <div class="video-wrapper">
                <img id="videoFeedElement" src="/video_feed" alt="Loading live feed..." />
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // --- YEH HAI CORRECTION ---
        // Yahan Codespace ka public URL aayega
        const SERVER_URL = ("https://shadowy-spooky-monster-4j66759gxrg72qj74-8000.app.github.dev/"); // Yeh line apne aap Codespace ka URL le legi
        const socket = io(SERVER_URL, { path: "/socket.io" }); // Path add karna zaroori hai
        // -------------------------

        const countElement = document.getElementById('count');
        const predictionElement = document.getElementById('prediction');
        const countBoxElement = document.getElementById('count-box');
        const predictionLabelElement = document.getElementById('prediction-label');
        const predictionSlider = document.getElementById('predictionSlider');
        let originalTitle = document.title;
        let alertActive = false;
        const ALERT_THRESHOLD = 10;
        let fullPredictionData = {}; // Full prediction dictionary

        // Chart setup
        const ctx = document.getElementById('liveChart').getContext('2d');
        const liveChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [ { label: 'Live Count', data: [], borderColor: '#00ff87', backgroundColor: 'rgba(0, 255, 135, 0.1)', fill: true, tension: 0.4, borderWidth: 2 }, { label: 'Predicted Count (Selected)', data: [], borderColor: '#0dcaf0', borderDash: [5, 5], fill: false, tension: 0.4, borderWidth: 2 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: 'white' } }, x: { ticks: { color: 'white' } } }, plugins: { legend: { labels: { color: 'white' } }, annotation: { annotations: { thresholdLine: { type: 'line', yMin: ALERT_THRESHOLD, yMax: ALERT_THRESHOLD, borderColor: 'red', borderWidth: 2, borderDash: [10, 5], label: { content: 'Alert Threshold', display: true, position: 'end', color: 'red', backgroundColor: 'rgba(30, 30, 30, 0.6)' } } } } } }
        });

        // Graph update function
        function addDataToChart(label, liveData, predictedData) {
            liveChart.data.labels.push(label);
            liveChart.data.datasets[0].data.push(liveData);
            const predictionPoint = (predictedData !== undefined && predictedData !== null) ? Number(predictedData) : null;
            liveChart.data.datasets[1].data.push(predictionPoint);
            if (liveChart.data.labels.length > 20) {
                liveChart.data.labels.shift();
                liveChart.data.datasets.forEach((ds) => ds.data.shift());
            }
            liveChart.update();
        }

        // --- CORRECTED: Function to update prediction display ---
        function updateDisplayedPrediction() {
             const minutes = predictionSlider.value;
             predictionLabelElement.innerText = `Prediction (Next ${minutes} min):`;
             // Sahi key se data nikaalo (e.g., "5min", "10min")
             const predictionKey = `${minutes}min`; 
             const predictedValue = (fullPredictionData && fullPredictionData[predictionKey] !== undefined)
                                     ? fullPredictionData[predictionKey]
                                     : "..."; // Agar data na mile to "..." dikhao
             predictionElement.innerText = `~${predictedValue}`;
        }
        // --------------------------------------------------------

        // Slider event listener
        predictionSlider.addEventListener('input', updateDisplayedPrediction);

        socket.on('connect', () => {
             console.log('âœ… Server se connect ho gaya!');
             countElement.innerText = "0";
             updateDisplayedPrediction(); // Shuru mein prediction display set karo
             countBoxElement.className = 'panel count-box status-safe';
         });
        socket.on('disconnect', () => {
             console.log('âŒ Server se connection toot gaya!');
             countElement.innerText = "Offline";
             predictionElement.innerText = "Prediction: Offline";
             countBoxElement.className = 'panel count-box';
         });

        // Jab server se naya data aaye
        socket.on('broadcast_data', (data) => {
            console.log("Data received:", data); // Debugging ke liye
            const count = data.count;
            // --- CORRECTED: Data ko 'fullPredictionData' mein save karo ---
            fullPredictionData = data.prediction || {}; // Ensure it's an object
            // ----------------------------------------------------------

            countElement.innerText = count;
            updateDisplayedPrediction(); // Slider ke hisab se prediction update karo

            // Box ka color update karo
            let statusClass = 'status-safe';
            if (count > ALERT_THRESHOLD) {
                statusClass = 'status-danger';
                if (!alertActive) { document.title = "ðŸš¨ CROWD ALERT! ðŸš¨"; alertActive = true; }
            } else if (count > ALERT_THRESHOLD / 2) {
                statusClass = 'status-moderate';
                if (alertActive) { document.title = originalTitle; alertActive = false; }
            } else {
                if (alertActive) { document.title = originalTitle; alertActive = false; }
            }
            countBoxElement.className = `panel count-box ${statusClass}`;

            // Graph ko update karo
            const currentTime = new Date().toLocaleTimeString();
            const currentSliderValue = predictionSlider.value;
            const currentPredictionKey = `${currentSliderValue}min`;
            const currentPredictedValueForChart = (fullPredictionData && fullPredictionData[currentPredictionKey] !== undefined) ? fullPredictionData[currentPredictionKey] : null;
            addDataToChart(currentTime, count, currentPredictedValueForChart);
        });

        const videoFeedImg = document.getElementById('videoFeedElement');
        videoFeedImg.onerror = () => console.error("Error loading video feed.");
    </script>
</body>
</html>